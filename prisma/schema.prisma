generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BotUser {
  id               Int      @id @default(autoincrement())
  telegramUsername String   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Chat {
  id             Int      @id @default(autoincrement())
  telegramChatId String   @unique
  title          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  chatDevices ChatDevice[]
}

model Device {
  id        Int      @id @default(autoincrement())
  deviceNo  Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sims        Sim[]
  chatDevices ChatDevice[]
}

model ChatDevice {
  id       Int @id @default(autoincrement())
  chatId   Int
  deviceId Int

  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([chatId])
}

model Sim {
  id               Int       @id @default(autoincrement())
  phone            String    @unique
  simNo            Int
  bkLimit          Float
  ngLimit          Float
  bkBalance        Float     @default(0)
  ngBalance        Float     @default(0)
  bkSM             Float     @default(0)
  bkCO             Float     @default(0)
  bkMER            Float     @default(0)
  ngSM             Float     @default(0)
  ngCO             Float     @default(0)
  ngMER            Float     @default(0)
  bkTotalIn        Float     @default(0)
  bkTotalSM        Float     @default(0)
  bkTotalCO        Float     @default(0)
  bkTotalMER       Float     @default(0)
  ngTotalIn        Float     @default(0)
  ngTotalSM        Float     @default(0)
  ngTotalCO        Float     @default(0)
  ngTotalMER       Float     @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastCashedInDate DateTime?

  deviceId Int?
  device   Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  simTransactionHistories SimTransactionHistory[]

  @@unique([phone, simNo])
  @@unique([deviceId, simNo])
}

model SimTransactionHistory {
  id         Int      @id @default(autoincrement())
  operation  String
  type       String // IN or OUT
  amount     Float
  charge     Float
  note       String?
  operatedBy String?
  createdAt  DateTime @default(now())
  simId      Int

  sim Sim @relation(fields: [simId], references: [id])
}
